{"version":3,"file":"index.js","sources":["../src/utils.ts","../src/index.ts"],"sourcesContent":["export const createBasePath = (base?: string) => {\n  return (base?.replace(/\\/$/, '') || '') + '/@imagetools/'\n}\n","import { basename, extname } from 'node:path'\nimport { Plugin, ResolvedConfig } from 'vite'\nimport {\n  parseURL,\n  loadImage,\n  builtins,\n  resolveConfigs,\n  applyTransforms,\n  generateTransforms,\n  getMetadata,\n  generateImageID,\n  builtinOutputFormats,\n  urlFormat,\n  extractEntries,\n  type ImageConfig,\n  type Logger,\n  type OutputFormat\n} from 'imagetools-core'\nimport { createFilter, dataToEsm } from '@rollup/pluginutils'\nimport type { Metadata, Sharp } from 'sharp'\nimport { createBasePath } from './utils.js'\nimport type { VitePluginOptions } from './types.js'\n\nexport type {\n  Include,\n  Exclude,\n  DefaultDirectives,\n  ExtendTransforms,\n  ExtendOutputFormats,\n  ResolveConfigs,\n  VitePluginOptions\n} from './types.js'\n\nconst defaultOptions: VitePluginOptions = {\n  include: /^[^?]+\\.(heic|heif|avif|jpeg|jpg|png|tiff|webp|gif)(\\?.*)?$/,\n  exclude: 'public/**/*',\n  removeMetadata: true\n}\n\nexport * from 'imagetools-core'\n\nexport function imagetools(userOptions: Partial<VitePluginOptions> = {}): Plugin {\n  const pluginOptions: VitePluginOptions = { ...defaultOptions, ...userOptions }\n\n  const filter = createFilter(pluginOptions.include, pluginOptions.exclude)\n\n  const transformFactories = pluginOptions.extendTransforms ? pluginOptions.extendTransforms(builtins) : builtins\n\n  const outputFormats: Record<string, OutputFormat> = pluginOptions.extendOutputFormats\n    ? pluginOptions.extendOutputFormats(builtinOutputFormats)\n    : builtinOutputFormats\n\n  let viteConfig: ResolvedConfig\n  let basePath: string\n\n  const generatedImages = new Map()\n\n  return {\n    name: 'imagetools',\n    enforce: 'pre',\n    configResolved(cfg) {\n      viteConfig = cfg\n      basePath = createBasePath(viteConfig.base)\n    },\n    async load(id) {\n      if (!filter(id)) return null\n\n      const srcURL = parseURL(id)\n\n      // lazy loaders so that we can load the metadata in defaultDirectives if needed\n      // but if there are no directives then we can just skip loading\n      let lazyImg: Sharp\n      const lazyLoadImage = () => {\n        if (lazyImg) return lazyImg\n        return (lazyImg = loadImage(decodeURIComponent(srcURL.pathname)))\n      }\n\n      let lazyMetadata: Metadata\n      const lazyLoadMetadata = async () => {\n        if (lazyMetadata) return lazyMetadata\n        return (lazyMetadata = await lazyLoadImage().metadata())\n      }\n\n      const defaultDirectives =\n        typeof pluginOptions.defaultDirectives === 'function'\n          ? await pluginOptions.defaultDirectives(srcURL, lazyLoadMetadata)\n          : pluginOptions.defaultDirectives || new URLSearchParams()\n      const directives = new URLSearchParams({\n        ...Object.fromEntries(defaultDirectives),\n        ...Object.fromEntries(srcURL.searchParams)\n      })\n\n      if (!directives.toString()) return null\n\n      const img = lazyLoadImage()\n      if (directives.get('allowUpscale') !== 'true') {\n        const metadata = await lazyLoadMetadata()\n        const intrinsicWidth = metadata.width || 0\n        const intrinsicHeight = metadata.height || 0\n\n        const originalWidths = directives.get('w')?.split(';') || []\n        const widths = originalWidths.filter((d) => parseInt(d) <= intrinsicWidth)\n        if (widths.length != originalWidths.length) {\n          if (widths.length) {\n            directives.set('w', widths.join(';'))\n          } else {\n            directives.delete('w')\n          }\n        }\n\n        const originalHeights = directives.get('h')?.split(';') || []\n        const heights = originalHeights.filter((d) => parseInt(d) <= intrinsicHeight)\n        if (heights.length != originalHeights.length) {\n          if (heights.length) {\n            directives.set('h', heights.join(';'))\n          } else {\n            directives.delete('h')\n          }\n        }\n      }\n\n      const parameters = extractEntries(directives)\n      const imageConfigs =\n        pluginOptions.resolveConfigs?.(parameters, outputFormats) ?? resolveConfigs(parameters, outputFormats)\n\n      const outputMetadatas: Array<ImageConfig> = []\n\n      const logger: Logger = {\n        info: (msg) => viteConfig.logger.info(msg),\n        warn: (msg) => this.warn(msg),\n        error: (msg) => this.error(msg)\n      }\n\n      for (const config of imageConfigs) {\n        const { transforms } = generateTransforms(config, transformFactories, srcURL.searchParams, logger)\n        const { image, metadata } = await applyTransforms(transforms, img.clone(), pluginOptions.removeMetadata)\n\n        if (viteConfig.command === 'serve') {\n          const id = generateImageID(srcURL, config)\n          generatedImages.set(id, image)\n          metadata.src = basePath + id\n        } else {\n          const fileHandle = this.emitFile({\n            name: basename(srcURL.pathname, extname(srcURL.pathname)) + `.${metadata.format}`,\n            source: await image.toBuffer(),\n            type: 'asset'\n          })\n\n          metadata.src = `__VITE_ASSET__${fileHandle}__`\n        }\n\n        metadata.image = image\n\n        outputMetadatas.push(metadata)\n      }\n\n      let outputFormat = urlFormat()\n      const asParam = directives.get('as')?.split(':')\n      const as = asParam ? asParam[0] : undefined\n      for (const [key, format] of Object.entries(outputFormats)) {\n        if (as === key) {\n          outputFormat = format(asParam && asParam[1] ? asParam[1].split(';') : undefined)\n          break\n        }\n      }\n\n      return dataToEsm(await outputFormat(outputMetadatas), {\n        namedExports: viteConfig.json?.namedExports ?? true,\n        compact: !!viteConfig.build.minify ?? false,\n        preferConst: true\n      })\n    },\n\n    configureServer(server) {\n      server.middlewares.use((req, res, next) => {\n        if (req.url?.startsWith(basePath)) {\n          const [, id] = req.url.split(basePath)\n\n          const image = generatedImages.get(id)\n\n          if (!image)\n            throw new Error(`vite-imagetools cannot find image with id \"${id}\" this is likely an internal error`)\n\n          if (pluginOptions.removeMetadata === false) {\n            image.withMetadata()\n          }\n\n          res.setHeader('Content-Type', `image/${getMetadata(image, 'format')}`)\n          res.setHeader('Cache-Control', 'max-age=360000')\n          return image.clone().pipe(res)\n        }\n\n        next()\n      })\n    }\n  }\n}\n"],"names":[],"mappings":"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"}